<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>James Basketball System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 2px solid #f39c12;
        }
        .header h1 { font-size: 2em; color: #f39c12; }
        .header p { color: #bbb; margin-top: 8px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }
        .tab-btn:hover { background: rgba(243,156,18,0.3); }
        .tab-btn.active {
            background: #f39c12;
            color: #1a1a2e;
            font-weight: bold;
        }

        /* å†…å®¹åŒº */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* æœç´¢æ¡† */
        .search-box {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .search-box input, .search-box select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        .search-box input::placeholder { color: #aaa; }
        .search-box input:focus, .search-box select:focus {
            outline: none;
            border-color: #f39c12;
        }
        .search-box select option { background: #1a1a2e; }

        /* è¡¨æ ¼æ ·å¼ */
        .table-wrapper {
            overflow-x: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(243,156,18,0.2);
            color: #f39c12;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:hover { background: rgba(255,255,255,0.05); }

        /* åäººå ‚æ ‡è®° */
        .hall-of-fame { color: #f39c12; font-weight: bold; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .badge-gold { background: #f39c12; color: #1a1a2e; }
        .badge-blue { background: #3498db; color: #fff; }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        .stat-card .number { font-size: 2.5em; color: #f39c12; font-weight: bold; }
        .stat-card .label { color: #aaa; margin-top: 5px; }

        /* åˆ†é¡µå®¹å™¨ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* åˆ†é¡µæŒ‰é’®ï¼ˆç»Ÿä¸€ä¸º tab é£æ ¼ï¼‰ */
        .page-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 0.95em;
        }

        .page-btn:hover:not(.active):not(:disabled) {
            background: rgba(243,156,18,0.3);
            border-color: #f39c12;
        }

        /* å½“å‰é¡µ */
        .page-btn.active {
            background: #f39c12;
            color: #1a1a2e;
            font-weight: bold;
            cursor: default;
        }

        /* ç¦ç”¨çŠ¶æ€ */
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* çœç•¥å· */
        .page-ellipsis {
            padding: 8px 6px;
            color: #aaa;
            font-size: 1em;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading { text-align: center; padding: 40px; color: #aaa; }
    </style>
</head>
<body>
<div class="header">
    <h1>ğŸ€ James Basketball System</h1>
    <p>NBA çƒæ˜Ÿæ•°æ®å±•ç¤ºç³»ç»Ÿ</p>
</div>

<div class="container">
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('players')">ğŸ‘¤ çƒå‘˜åˆ—è¡¨</button>
        <button class="tab-btn" onclick="showTab('teams')">ğŸ€ çƒé˜Ÿåˆ—è¡¨</button>
        <button class="tab-btn" onclick="showTab('positions')">ğŸ“ ä½ç½®å­—å…¸</button>
        <button class="tab-btn" onclick="showTab('colleges')">ğŸ“ çƒå‘˜å¤§å­¦</button>
    </div>

    <!-- çƒå‘˜åˆ—è¡¨ -->
    <div id="players" class="tab-content active">
        <div class="stats-grid" id="playerStats"></div>
        <div class="search-box">
            <input type="text" id="playerSearch" placeholder="æœç´¢çƒå‘˜å§“å..." onkeyup="filterPlayers()">
            <select id="positionFilter" onchange="filterPlayers()">
                <option value="">å…¨éƒ¨ä½ç½®</option>
            </select>
            <select id="hofFilter" onchange="filterPlayers()">
                <option value="">å…¨éƒ¨çƒå‘˜</option>
                <option value="1">åäººå ‚çƒå‘˜</option>
                <option value="0">éåäººå ‚çƒå‘˜</option>
            </select>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>å§“å</th>
                        <th>ä½ç½®</th>
                        <th>åäººå ‚</th>
                        <th>é¦–ç§€å¹´ä»½</th>
                        <th>é€€å½¹å¹´ä»½</th>
                        <th>èº«é«˜</th>
                        <th>ä½“é‡(ç£…)</th>
                        <th>å‡ºç”Ÿæ—¥æœŸ</th>
                    </tr>
                </thead>
                <tbody id="playerTable">
                    <tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="pagination" class="pagination"></div>


    </div>

    <!-- çƒé˜Ÿåˆ—è¡¨ -->
    <div id="teams" class="tab-content">
        <div class="stats-grid" id="teamStats"></div>
        <div class="search-box">
            <input type="text" id="teamSearch" placeholder="æœç´¢çƒé˜Ÿåç§°..." onkeyup="filterTeams()">
            <select id="champFilter" onchange="filterTeams()">
                <option value="">å…¨éƒ¨çƒé˜Ÿ</option>
                <option value="1">æœ‰æ€»å† å†›</option>
                <option value="0">æ— æ€»å† å†›</option>
            </select>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>çƒé˜Ÿåç§°</th>
                        <th>è”ç›Ÿ</th>
                        <th>æˆç«‹</th>
                        <th>å¹´æ•°</th>
                        <th>èƒœ</th>
                        <th>è´Ÿ</th>
                        <th>èƒœç‡</th>
                        <th>å­£åèµ›</th>
                        <th>åˆ†åŒºå† å†›</th>
                        <th>è”ç›Ÿå† å†›</th>
                        <th>æ€»å† å†›</th>
                    </tr>
                </thead>
                <tbody id="teamTable">
                    <tr><td colspan="11" class="loading">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="teamPagination" class="pagination"></div>
    </div>

    <!-- ä½ç½®å­—å…¸ -->
    <div id="positions" class="tab-content">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ä½ç½®ä»£ç </th>
                        <th>ä½ç½®åç§°</th>
                        <th>ä½ç½®æè¿°</th>
                    </tr>
                </thead>
                <tbody id="positionTable">
                    <tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="positionPagination" class="pagination"></div>
    </div>

    <!-- çƒå‘˜å¤§å­¦ -->
    <div id="colleges" class="tab-content">
        <div class="search-box">
            <input type="text" id="collegeSearch" placeholder="æœç´¢å¤§å­¦åç§°..." onkeyup="filterColleges()">
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>çƒå‘˜ID</th>
                        <th>çƒå‘˜å§“å</th>
                        <th>å¤§å­¦åç§°</th>
                    </tr>
                </thead>
                <tbody id="collegeTable">
                    <tr><td colspan="4" class="loading">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="collegePagination" class="pagination"></div>
    </div>
</div>

<script>

    let allPlayers = [];
    let allPositions = [];
    let allColleges = [];
    let allTeams = [];
    let playerMap = {};

    const pageSize = 24;
    
    // å„è¡¨æ ¼åˆ†é¡µçŠ¶æ€
    let playerPage = 1, teamPage = 1, positionPage = 1, collegePage = 1;
    let filteredPlayersCache = [];
    let filteredTeamsCache = [];
    let filteredPositionsCache = [];
    let filteredCollegesCache = [];

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // åŠ è½½çƒå‘˜æ•°æ®
    async function loadPlayers() {
        try {
            const res = await fetch('/api/players');
            allPlayers = await res.json();
            playerMap = {};
            allPlayers.forEach(p => playerMap[p.playerId] = p.playerName);
            renderPlayers(allPlayers);
            renderPlayerStats();
        } catch (e) {
            document.getElementById('playerTable').innerHTML = '<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    // æ¸²æŸ“çƒå‘˜è¡¨æ ¼
    function renderPlayers(players) {
        filteredPlayersCache = players;

        const tbody = document.getElementById('playerTable');
        if (players.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9">æš‚æ— æ•°æ®</td></tr>';
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        const start = (playerPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = players.slice(start, end);

        tbody.innerHTML = pageData.map(p => `
        <tr>
            <td>${p.playerId}</td>
            <td class="${p.isHallOfFame ? 'hall-of-fame' : ''}">${p.playerName}</td>
            <td><span class="badge badge-blue">${p.position || '-'}</span></td>
            <td>${p.isHallOfFame ? '<span class="badge badge-gold">ğŸ† åäººå ‚</span>' : '-'}</td>
            <td>${p.nbaDebutYear || '-'}</td>
            <td>${p.nbaFinalYear || '-'}</td>
            <td>${p.heightFt ? p.heightFt + "'" + (p.heightIn || 0) + '"' : '-'}</td>
            <td>${p.weightLbs || '-'}</td>
            <td>${p.birthDate || '-'}</td>
        </tr>
    `).join('');

        renderPaginationGeneric('pagination', players.length, playerPage, changePlayerPage);
    }


    // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
    function renderPlayerStats() {
        const total = allPlayers.length;
        const hof = allPlayers.filter(p => p.isHallOfFame).length;
        const active = allPlayers.filter(p => !p.nbaFinalYear || p.nbaFinalYear >= 2024).length;
        document.getElementById('playerStats').innerHTML = `
            <div class="stat-card"><div class="number">${total}</div><div class="label">çƒå‘˜æ€»æ•°</div></div>
            <div class="stat-card"><div class="number">${hof}</div><div class="label">åäººå ‚çƒå‘˜</div></div>
            <div class="stat-card"><div class="number">${active}</div><div class="label">ç°å½¹/è¿‘æœŸçƒå‘˜</div></div>
        `;
    }

    // ç­›é€‰çƒå‘˜
    function filterPlayers() {
        const search = document.getElementById('playerSearch').value.toLowerCase();
        const position = document.getElementById('positionFilter').value;
        const hof = document.getElementById('hofFilter').value;

        const filtered = allPlayers.filter(p => {
            const matchName = p.playerName.toLowerCase().includes(search);
            const matchPos = !position || p.position === position;
            const matchHof = hof === '' || (hof === '1' ? p.isHallOfFame : !p.isHallOfFame);
            return matchName && matchPos && matchHof;
        });

        playerPage = 1;
        renderPlayers(filtered);
    }


    // åŠ è½½ä½ç½®æ•°æ®
    async function loadPositions() {
        try {
            const res = await fetch('/api/positions');
            allPositions = await res.json();
            renderPositions();
            populatePositionFilter();
        } catch (e) {
            document.getElementById('positionTable').innerHTML = '<tr><td colspan="3">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function renderPositions(positions) {
        positions = positions || allPositions;
        filteredPositionsCache = positions;
        
        const tbody = document.getElementById('positionTable');
        if (positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">æš‚æ— æ•°æ®</td></tr>';
            document.getElementById('positionPagination').innerHTML = '';
            return;
        }
        
        const start = (positionPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = positions.slice(start, end);
        
        tbody.innerHTML = pageData.map(p => `
            <tr>
                <td><span class="badge badge-blue">${p.positionCode}</span></td>
                <td>${p.positionName || '-'}</td>
                <td>${p.positionDesc || '-'}</td>
            </tr>
        `).join('');
        
        renderPaginationGeneric('positionPagination', positions.length, positionPage, changePositionPage);
    }

    function populatePositionFilter() {
        const select = document.getElementById('positionFilter');
        allPositions.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.positionCode;
            opt.textContent = p.positionCode + (p.positionName ? ' - ' + p.positionName : '');
            select.appendChild(opt);
        });
    }

    // åŠ è½½å¤§å­¦æ•°æ® - éœ€è¦å…ˆè·å–æ‰€æœ‰çƒå‘˜çš„å¤§å­¦
    async function loadColleges() {
        try {
            // è·å–æ‰€æœ‰çƒå‘˜çš„å¤§å­¦ä¿¡æ¯
            const collegePromises = allPlayers.slice(0, 100).map(p =>
                fetch(`/api/player-colleges/player/${p.playerId}`).then(r => r.json()).catch(() => [])
            );
            const results = await Promise.all(collegePromises);
            allColleges = results.flat();
            renderColleges(allColleges);
        } catch (e) {
            document.getElementById('collegeTable').innerHTML = '<tr><td colspan="4">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function renderColleges(colleges) {
        colleges = colleges || allColleges;
        filteredCollegesCache = colleges;
        
        const tbody = document.getElementById('collegeTable');
        if (colleges.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">æš‚æ— æ•°æ®</td></tr>';
            document.getElementById('collegePagination').innerHTML = '';
            return;
        }
        
        const start = (collegePage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = colleges.slice(start, end);
        
        tbody.innerHTML = pageData.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${c.playerId}</td>
                <td>${playerMap[c.playerId] || '-'}</td>
                <td>${c.collegeName}</td>
            </tr>
        `).join('');
        
        renderPaginationGeneric('collegePagination', colleges.length, collegePage, changeCollegePage);
    }

    function filterColleges() {
        const search = document.getElementById('collegeSearch').value.toLowerCase();
        const filtered = allColleges.filter(c => c.collegeName.toLowerCase().includes(search));
        collegePage = 1;
        renderColleges(filtered);
    }

    // é€šç”¨åˆ†é¡µæ¸²æŸ“
    function renderPaginationGeneric(containerId, total, currentPage, changeFunc) {
        const totalPages = Math.ceil(total / pageSize);
        const container = document.getElementById(containerId);

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        const maxAround = 2;
        let html = '';

        html += `<button class="page-btn" onclick="${changeFunc.name}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;

        const pages = [];
        pages.push(1);

        let start = Math.max(2, currentPage - maxAround);
        let end = Math.min(totalPages - 1, currentPage + maxAround);

        if (start > 2) pages.push('...');
        for (let i = start; i <= end; i++) pages.push(i);
        if (end < totalPages - 1) pages.push('...');

        if (totalPages > 1) pages.push(totalPages);

        pages.forEach(p => {
            if (p === '...') {
                html += `<span class="page-ellipsis">...</span>`;
            } else if (p === currentPage) {
                html += `<button class="page-btn active">${p}</button>`;
            } else {
                html += `<button class="page-btn" onclick="${changeFunc.name}(${p})">${p}</button>`;
            }
        });

        html += `<button class="page-btn" onclick="${changeFunc.name}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

        container.innerHTML = html;
    }

    function changePlayerPage(page) {
        const totalPages = Math.ceil(filteredPlayersCache.length / pageSize);
        if (page < 1 || page > totalPages) return;
        playerPage = page;
        renderPlayers(filteredPlayersCache);
    }

    function changeTeamPage(page) {
        const totalPages = Math.ceil(filteredTeamsCache.length / pageSize);
        if (page < 1 || page > totalPages) return;
        teamPage = page;
        renderTeams(filteredTeamsCache);
    }

    function changePositionPage(page) {
        const totalPages = Math.ceil(filteredPositionsCache.length / pageSize);
        if (page < 1 || page > totalPages) return;
        positionPage = page;
        renderPositions(filteredPositionsCache);
    }

    function changeCollegePage(page) {
        const totalPages = Math.ceil(filteredCollegesCache.length / pageSize);
        if (page < 1 || page > totalPages) return;
        collegePage = page;
        renderColleges(filteredCollegesCache);
    }


    // åŠ è½½çƒé˜Ÿæ•°æ®
    async function loadTeams() {
        try {
            const res = await fetch('/api/teams');
            allTeams = await res.json();
            renderTeams(allTeams);
            renderTeamStats();
        } catch (e) {
            document.getElementById('teamTable').innerHTML = '<tr><td colspan="11">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function renderTeams(teams) {
        teams = teams || allTeams;
        filteredTeamsCache = teams;
        
        const tbody = document.getElementById('teamTable');
        if (teams.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11">æš‚æ— æ•°æ®</td></tr>';
            document.getElementById('teamPagination').innerHTML = '';
            return;
        }
        
        const start = (teamPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = teams.slice(start, end);
        
        tbody.innerHTML = pageData.map(t => `
            <tr>
                <td class="${t.championships > 0 ? 'hall-of-fame' : ''}">${t.franchiseName}</td>
                <td><span class="badge badge-blue">${t.league}</span></td>
                <td>${t.yearFrom}</td>
                <td>${t.years}</td>
                <td>${t.wins}</td>
                <td>${t.losses}</td>
                <td>${(t.winLossPct * 100).toFixed(1)}%</td>
                <td>${t.playoffs}</td>
                <td>${t.divisionTitles}</td>
                <td>${t.conferenceTitles}</td>
                <td>${t.championships > 0 ? '<span class="badge badge-gold">ğŸ† ' + t.championships + '</span>' : '-'}</td>
            </tr>
        `).join('');
        
        renderPaginationGeneric('teamPagination', teams.length, teamPage, changeTeamPage);
    }

    function renderTeamStats() {
        const total = allTeams.length;
        const champs = allTeams.filter(t => t.championships > 0).length;
        const totalChampionships = allTeams.reduce((sum, t) => sum + t.championships, 0);
        document.getElementById('teamStats').innerHTML = `
            <div class="stat-card"><div class="number">${total}</div><div class="label">çƒé˜Ÿæ€»æ•°</div></div>
            <div class="stat-card"><div class="number">${champs}</div><div class="label">æœ‰å† å†›çƒé˜Ÿ</div></div>
            <div class="stat-card"><div class="number">${totalChampionships}</div><div class="label">æ€»å† å†›æ•°</div></div>
        `;
    }

    function filterTeams() {
        const search = document.getElementById('teamSearch').value.toLowerCase();
        const champ = document.getElementById('champFilter').value;
        
        const filtered = allTeams.filter(t => {
            const matchName = t.franchiseName.toLowerCase().includes(search);
            const matchChamp = champ === '' || (champ === '1' ? t.championships > 0 : t.championships === 0);
            return matchName && matchChamp;
        });
        teamPage = 1;
        renderTeams(filtered);
    }

    // åˆå§‹åŒ–
    async function init() {
        await loadPlayers();
        await loadPositions();
        await loadColleges();
        await loadTeams();
    }
    init();
</script>
</body>
</html>
